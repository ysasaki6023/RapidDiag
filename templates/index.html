<!DOCTYPE html>
<html>
  <head>

      <title>{{ user_name }}</title>

    <link rel="stylesheet" href={{css_url}}/>

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>
        /////////////////////////////////////////////////////////////////////
        // プロジェクト系の設定

        $(window).load(function () {

            // 行を追加する関数
            var add_new_category_line = function(category_id,category_name,category_type,items_uploaded){
                // 問い合わせたcategory_idに対応する行を作成する
                htmlStr = '<tr>'+
                        '<td width=20%>'+
                        '<input type="text" name="category_name" class="input" category_index="'+category_id+'" value="'+category_name+'">'+
                        '</td>'+
                        '<td width=20%>'
                if(category_type=="train")
                {
                    htmlStr +='<input type="radio" name="train_or_test_'+category_id+'" value="train" checked>学習用'+
                        '<br>'+
                        '<input type="radio" name="train_or_test_'+category_id+'" value="test">評価用'+
                        '</td>'
                }
                else
                {
                    htmlStr +='<input type="radio" name="train_or_test_'+category_id+'" value="train">学習用'+
                        '<br>'+
                        '<input type="radio" name="train_or_test_'+category_id+'" value="test" checked>評価用'+
                        '</td>'
                }
                htmlStr += '<td width=50%>'+
                            '<div class="drag-area" category_index="'+category_id+'">'+
                                '<div class="w3-light-grey" style="width:80%">'
                if(items_uploaded==0)
                {
                    htmlStr +=          '<div class="w3-container w3-blue-before w3-center" style="width:100%">Drop files here</div>';
                }
                else
                {
                    htmlStr +=          '<div class="w3-container w3-blue w3-center" style="width:100%">'+items_uploaded+'/'+items_uploaded+' (100%)</div>';
                }
                htmlStr +=     '</div>'+
                            '</div>'+
                        '</td>'+
                        '<td width=10%>'+
                            '<button class="del-line" type="button" name="delete" category_index="'+category_id+'" >削除</button>'+
                        '</td>'+
                    '</tr>'
                $('#dataTable tbody').append(htmlStr);

            };


            // 全体の更新
            var update_view_project = function(){
                var defer = $.Deferred();
                $("#project_name_new").val("");
                $.ajax({
                    url:"/show_project",
                    type:"POST",
                    contentType: "application/json; charset=utf-8"
                }).then(function(data){
                    // project_select_listの更新
                    $("#project_select_list").html("");
                    for(var i=data.project_name.length-1;i>=0;i--){
                        var newItem = "<option value="+data.project_name[i];
                        if(i==(data.project_name.length-1))
                            newItem += " selected"
                        newItem += ">"+data.project_name[i]+"</option>";
                        $("#project_select_list").append(newItem);
                    }
                    defer.resolve();
                });
                return defer.promise();
            }

            var update_view_category = function(){
                var defer = $.Deferred();
                project_name = $("#project_select_list").val();
                console.log(project_name);
                if(project_name==null)
                {return false;}

                // TODO: カテゴリの更新
                $.ajax({
                    url:"/get_category",
                    type:"POST",
                    contentType: "application/json; charset=utf-8",
                    data:JSON.stringify({"project_name":project_name})
                }).then(function(data){
                    console.log(data);
                    $('#dataTable tr').remove();
                    for(var i=0; i<data.items.length; i++)
                    {
                        add_new_category_line(data.items[i].category_id,data.items[i].category_name,data.items[i].category_type,data.items[i].items_uploaded);
                    }
                    defer.resolve();
                });
                return defer.promise();
            }

            // 初回の画面更新
            update_view_project();

            // プロジェクトの追加
            $("#project_select_list").on("change",function(){
                update_view_category();
            });

            $("#project_add").on("click",function()
                {
                    var project_name = $("#project_name_new").val();
                    if(project_name=="")
                    {
                        alert("プロジェクト名未入力");
                    }
                    else
                    {
                        $.ajax({
                            url:"/new_project",
                            type:"POST",
                            contentType: "application/json; charset=utf-8",
                            data:JSON.stringify({"project_name":project_name})
                        }).then(function(){
                            update_view_project().then(function(){
                                update_view_category();
                            });
                        });
                    }
                });

            // プロジェクトの削除
            $("#project_del").on("click",function()
                {
                    var project_name = $("#project_select_list").val();
                    {
                        $.ajax({
                            url:"/del_project",
                            type:"POST",
                            contentType: "application/json; charset=utf-8",
                            data:JSON.stringify({"project_name":project_name})
                        }).then(function(){
                            update_view_project().then(update_view_category());
                        });
                    }
                });

        /////////////////////////////////////////////////////////////////////
        // データの読み込み・カテゴリ修正に関する設定
            // 行を追加ボタン
            var add_category = function() {
                // 初期値を取得
                project_name = $("#project_select_list").val();
                if(project_name==null){ return false; }

                // カテゴリ番号を取得して、リストを追加する
                $.ajax({
                    url:"/add_category",
                    type:"POST",
                    contentType: "application/json; charset=utf-8",
                    data:JSON.stringify({"project_name":project_name})
                }).then(function(data){
                    category_id = data.category_id;
                    console.log("category_id="+category_id+" for project_name="+project_name);
                    add_new_category_line(category_id,"category名","train",0);
                });
            };

            // 行を追加ボタン実行時に上記が呼ばれるようにする
            $('#addRow').on('click', function(){add_category();});

            // 削除ボタンの実装
            $('tbody').on("click",'.del-line',function(){
                var project_name = $("#project_select_list").val();
                category_id = $(this).closest('tr').find('input').attr("category_index");
                console.log("project_name="+project_name+" category_id="+category_id);

                if(project_name==null){ return false; }
                $.ajax({
                    url:"/delete_category",
                    type:"POST",
                    contentType: "application/json; charset=utf-8",
                    data:JSON.stringify(
                        {"project_name":project_name,
                         "category_id":$(this).closest('tr').find('input').attr("category_index")
                        })
                }).then(function(data){
                    // 画面から削除する
                    update_view_category();
                });

            });

            // ファイルのアップロード処理
            var uploadFiles = function(files,category_id) {
                var project_name = $("#project_select_list").val();
                if(project_name==null){ return false; }

                // ファイルの個数を取得
                var filesLength = files.length;
                if(filesLength>0){
                    $(".w3-container").removeClass("w3-blue-before");
                    $(".w3-container").addClass("w3-blue");
                }

                var send_num = 0;

                // ファイル情報を追加
                for (var i = 0; i < filesLength; i++) {
                    // FormDataオブジェクトを用意
                    var fd = new FormData();
                    console.log(files[i]["name"]);
                    fd.append("file", files[i]);

                    // Ajaxでアップロード処理をするファイルへ内容渡す
                    $.ajax({
                        url: '/upload/'+project_name+"/"+category_id,
                        type: 'POST',
                        data: fd,
                        processData: false,
                        contentType: false
                    }).then(function(data) {
                        send_num += 1;
                        var progre = parseInt(send_num/filesLength * 100);
                        $('.drag-area[category_index="'+category_id+'"]').find('.w3-container').attr("style","width:"+progre+"%").text(send_num+"/"+filesLength+" ("+progre+"%)");
                            console.log(data);
                    },function(data) {
                        console.log(data.responseText);
                    });
                }
            };

            // ファイルドロップ時の処理
            $('tbody').on('drop','.drag-area',function(e){
                // デフォルトの挙動を停止
                e.preventDefault();

                // ファイル情報を取得
                var files = e.originalEvent.dataTransfer.files;
                uploadFiles(files,$(this).attr("category_index"));

            // デフォルトの挙動を停止　これがないと、ブラウザーによりファイルが開かれる
            }).on('dragenter','.drag-area', function(){
                return false;
            }).on('dragover','.drag-area', function(){
                return false;
            });

            // ボタンを押した時の処理
            $('tbody').on('click', '.drag-area', function() {
                var input = $(document.createElement("input"));
                input.attr("type", "file");
                files = input.trigger("click"); // opening dialog
                //uploadFiles(files,$(this).attr("category_index"));
                return false; // avoiding navigation
            });

            // カテゴリ名が変更されたときの処理
            var change_category = function(category_id) {
                var tr_item = $('tbody').find('input[category_index="'+category_id+'"]').closest('tr');
                var data = {
                    project_name : $("#project_select_list").val(),
                    category_id: category_id,
                    category_name: $(tr_item).find('input[name="category_name"]').val(),
                    category_type: $(tr_item).find('input[type="radio"]:checked').val()
                };
                console.log(JSON.stringify(data));

                $.ajax({
                    url: '/change_category',
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(data),
                });
                return false; // avoiding navigation
            };
            $('tbody').on('change', 'input[type="radio"]', function(){
                var category_id = $(this).closest('tr').find('input').attr("category_index");
                change_category(category_id);
                return false;});

            $('tbody').on('change', 'input[name="category_name"]', function(e){
                if (e.which === 13) {
                    var category_id = $(this).closest('tr').find('input').attr("category_index");
                    change_category(category_id);
                    return false;
                    }
                });

            // evaluate_startの処理
            var long_text = {};
            $('#evaluate_start').on('click', function() {
                console.log("start evaluation");
                var project_name = $("#project_select_list").val();
                if(project_name==null){ return false; }
                $.ajax({
                    url: '/evaluate',
                    type: 'POST',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({
                        project_name:project_name
                    }),
                }).then(function(data) {
                    console.log(data);
                    $("#separationTable tbody").html("");
                    // 1行目を作る
                    $("#separationTable tbody").append("<tr></tr>");
                    $("#separationTable tbody tr").append("<th></th>");
                    for(var i = 0; i<data.train_matrix.col.length; i++)
                    {
                        $("#separationTable tbody tr").append("<th>"+data.train_matrix.col[i]+"</th>");
                    }
                    // 2行目以降を作る
                    for(var i = 0; i<data.train_matrix.col.length; i++)
                    {
                        $("#separationTable tbody").append("<tr></tr>");
                        $("#separationTable tbody tr").last().append("<th>"+data.train_matrix.col[i]+"</th>");
                        for(var j = 0; j<data.train_matrix.col.length; j++)
                        {
                            var sep_val = "";
                            for(var p=0; p<data.train_pairs.length; p++)
                            {
                                if( (i==data.train_pairs[p].category_id_1) && (j==data.train_pairs[p].category_id_2) )
                                {
                                    sep_val = data.train_pairs[p].result_flag;
                                    break;
                                }
                            }
                            var sep_text = "";
                            var sep_long = "";
                            if(sep_val== 1){
                              sep_text = "正常識別<br>可能";
                              sep_long = "<div class='box-title'>"+data.train_matrix.col[i]+" は、正常に識別可能 ("+data.train_matrix.col[j]+"に対して)"+"</div>";
                              sep_long += "<p>"+data.train_matrix.col[i]+"に対して、ニューラルネットは、"+data.train_matrix.col[j]+" と区別をするための特徴量をうまく抽出できています。そのため、ニューラルネットによる学習・識別を行うことが可能です。</p>";
                            }

                            if(sep_val== 2){
                              sep_text = "データ数<br>不足";
                              sep_long = "<div class='box-title'>"+data.train_matrix.col[i]+" は、データ数不足 ("+data.train_matrix.col[j]+"に対して)"+"</div>";
                              sep_long += "<p>"+data.train_matrix.col[i]+"は、データ量が不足しており、正常に学習が行なえません。特に、"+data.train_matrix.col[j]+" と比較した時にデータ量不足が顕著です。"+"</p>";
                              sep_long += "<p>一方で、ニューラルネットが抽出する出力は、 "+data.train_matrix.col[j]+" とは大きく異なっているため、十分なデータ量を揃えて学習をさせた場合、ニューラルネットによる学習・識別を行うことが可能です。</p>";
                              sep_long += "<p class='next-step'> 推奨される対策 </p>";
                              sep_long += "<ul>";
                              sep_long += "<li>"+data.train_matrix.col[i]+"のデータを集め、再度評価する"+"</li>";
                              sep_long += "</ul>";
                            }
                            if(sep_val== 3){
                              sep_text = "識別<br>困難";
                              sep_long = "<div class='box-title'>"+data.train_matrix.col[i]+" は、識別困難 ("+data.train_matrix.col[j]+"に対して)"+"</div>";
                              sep_long += "<p>"+data.train_matrix.col[i]+"に関し、今回分析に使用した簡易的なニューラルネットワークでは、"+data.train_matrix.col[j]+"と区別を行うための十分な特徴量を見つけることができませんでした。</p>";
                              sep_long += "<p class='next-step'> 推奨される対策 </p>";
                              sep_long += "<ul>";
                              sep_long += "<li>"+data.train_matrix.col[i]+"と"+data.train_matrix.col[j]+"のデータが、きちんと別カテゴリかを再度確認する</li>";
                              sep_long += "<li>画像データ間でカテゴリの違い以上に大きな撮影条件の変化 (屋内・屋外、イラスト・写真、フラッシュあり・なし、など)がある場合、それを一定にして再度学習データを収集する。</li>";
                              sep_long += "<li>"+data.train_matrix.col[i]+"と"+data.train_matrix.col[j]+"のデータを、何も知らない第三者に見せた時に、きちんと分類できるかを確認する。もしできないようであれば、まず人間が識別可能な程度にきれいなデータ作成の方法について、専門家へ相談。</li>";
                              sep_long += "<li>人間に識別可能な場合には、ニューラルネットワークの学習の工夫による対応が必要。ディープラーニングの専門家へ相談。</li>";
                              sep_long += "</ul>";
                            }
                            if(sep_val== 4){
                              sep_text = "検知率<br>低";
                              sep_long = "<div class='box-title'>"+data.train_matrix.col[i]+" は、検出されず見逃される割合が多い ("+data.train_matrix.col[j]+"に対して)"+"</div>";
                              sep_long += "<p>"+data.train_matrix.col[i]+"は"+data.train_matrix.col[j]+"の特徴量と区別が付きづらくなっています。今回分析に使用した簡易的なニューラルネットワークでは判断に迷うものが多くありました。その他のニューラルネットワークでも、誤って見逃してしまうことが多く発生する可能性があります。</p>";
                              sep_long += "<p class='next-step'> 推奨される対策 </p>";
                              sep_long += "<ul>";
                              sep_long += "<li>画像データ収集時の撮影条件を一定に近づけて、再度データを収集。再評価を行う。</li>";
                              sep_long += "<li>混同されがちなデータを大量に準備し、ニューラルネットワークを学習させる。</li>";
                              sep_long += "<li>"+data.train_matrix.col[i]+"と"+data.train_matrix.col[j]+"のデータを、何も知らない第三者に見せた時に、期待される以上の精度で区別できるかを確認する。もしできないようであれば、まずきれいなデータ作成の方法について、専門家へ相談。</li>";
                              sep_long += "<li>人間に識別可能な場合には、ニューラルネットワークの学習の工夫による対応が必要です。ディープラーニングの専門家へ相談。</li>";
                              sep_long += "</ul>";
                            }
                            if(sep_val== 5){
                              sep_text = "他カテゴリ<br>混入";
                              sep_long = "<div class='box-title'>"+data.train_matrix.col[i]+" は、誤検知することが多い ("+data.train_matrix.col[j]+"に対して)"+"</div>";
                              sep_long += "<p>"+data.train_matrix.col[i]+"は"+data.train_matrix.col[j]+"の特徴量と区別が付きづらくなっています。今回分析に使用した簡易的なニューラルネットワークでは判断に迷うものが多くありました。その他のニューラルネットワークでも、誤検知が多く発生する可能性があります。</p>";
                              sep_long += "<p class='next-step'> 推奨される対策 </p>";
                              sep_long += "<ul>";
                              sep_long += "<li>画像データ収集時の撮影条件を一定に近づけて、再度データを収集。再評価を行う。</li>";
                              sep_long += "<li>混同されがちなデータを大量に準備し、ニューラルネットワークを学習させる。</li>";
                              sep_long += "<li>"+data.train_matrix.col[i]+"と"+data.train_matrix.col[j]+"のデータを、何も知らない第三者に見せた時に、期待される以上の精度で区別できるかを確認する。もしできないようであれば、まずきれいなデータ作成の方法について、専門家へ相談。</li>";
                              sep_long += "<li>人間に識別可能な場合には、ニューラルネットワークの学習の工夫による対応が必要です。ディープラーニングの専門家へ相談。</li>";
                              sep_long += "</ul>";
                            }
                            var sep_id = "sep_"+i+"_"+j;
                            long_text[sep_id] = sep_long;
                            $("#separationTable tbody tr").last().append("<td id='"+sep_id+"' class='sep_td_"+sep_val+"'>"+sep_text+"</td>");
                            $("#"+sep_id).on("click",function(){
                                console.log("clicked: "+$(this).attr("id"));
                                $("#sep_desc .sep_box").html(long_text[$(this).attr("id")]);
                            });
                        }
                    }
                },function(data) {
                });
            });
        });


    </script>

  </head>

  <body>
    <!-- ヘッダ -->
    <h1> Rapid Data Diagnosis</h1>

    <!-- プロジェクトの選定を行う -->
    <h2> Step1: プロジェクト名の設定/選定</h2>

    <div class="project_selection">
        プロジェクトを選択
        <select id="project_select_list">
        </select>
    </div>
    <div class="project_add_and_del">
        新規プロジェクトを追加
        <input id="project_name_new">
        </input>
        <button id="project_add">
            追加
        </button>
        <br>
        選択プロジェクトを削除
        <button id="project_del" class="button_red">
            削除
        </button>
    </div>

    <!-- データ送信を行う -->
    <h2> Step2: データのアップロード </h2>
    "アップロード進捗"バーの上に複数ファイルをドラッグアンドドロップ、もしくはクリックすることでファイルをアップロード
    <br>

    その後、分析結果がわかりやすいような"カテゴリ名"を指定します。それぞれのカテゴリが、学習データに属しているか、評価用のデータかも指定します。

    <table id="dataTable" width=90%>
        <thead>
            <tr>
                <th>カテゴリ名</th>
                <th>データ種別</th>
                <th>アップロード進捗</th>
                <th>削除</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <button type="button" id="addRow">1行追加</button>


    <!-- 分離度のチェックを行う -->
    <h2> Step3: データの評価 </h2>
    以下のボタンを押して、データの評価を開始
    <div>
        <div id="evaluate_start" class="square_btn">評価を開始</div>
    </div>

    <!-- 結果の表示 -->
    <h2> Step4: 結果の確認 </h2>

    <h3> 学習データ内での分離可否 </h4>
    学習するデータカテゴリ間で特徴的な差異が存在する場合、より学習がしやすくなります。
    ここでは、その差異の程度を表示しています。

    <table id="separationTable" width=90%>
        <tbody>
        </tbody>
    </table>

    <div id="sep_desc">
        <div class="sep_box">
            <div class="box-title">
                説明
            </div>
            <p>
                上記の表をクリックすると、マス目に対応する説明が表示されます
            </p>
        </div>
    </div>


  </body>
</html>
